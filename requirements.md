# 営業リスト処理システム要件定義書

## 1. プロジェクト概要

本プロジェクトは、営業リストを受け取り、構造化するバックエンドシステムの開発を目的としています。フロントエンドからアップロードされたファイルを処理し、LLM が扱いやすい形式に変換して返却します。

## 2. システムアーキテクチャ

### 2.1 全体構成

- **API Gateway**: FastAPI を使用したメインサービスハブ
- **データ処理サービス**: ファイルを受け取り、構造化する FastAPI アプリケーション
- **フロントエンド連携**: Next.js フロントエンドとの連携

### 2.2 技術スタック

- **バックエンド**: FastAPI
- **データ処理**: pandas, numpy
- **ファイル形式対応**: xlsx, xls, csv

## 3. 機能要件

### 3.1 ファイル受信機能

#### 3.1.1 ファイルアップロード

- multipart/form-data を使用したファイルアップロード対応
- 対応ファイル形式: xlsx, xls, csv
- 非対応形式の場合は適切なエラーメッセージを返却

```python
@app.post("/upload")
async def upload_file(file: UploadFile = File(...)):
    # ファイル形式検証
    # 保存処理
    # レスポンス返却
```

#### 3.1.2 ファイル検証

- ファイル拡張子の検証
- ファイルサイズの検証（上限設定）
- ファイル内容の基本検証

### 3.2 データ構造化機能

#### 3.2.1 必須情報検証

- カラム名/内容を読み取り、必要情報（会社名など）の存在確認
- キーワード検索によるカラム特定
- 必須情報が含まれない場合はエラー返却

#### 3.2.2 データ正規化

- セル結合の解除
- カラム名の英語 snake_case への統一
- ネスト構造のフラット化
- データ型の適正化:
  - 数値データの数値型変換
  - 日付データの YYYY-MM-DD 形式への統一
  - テキストデータの""での囲み
- 欠損データの除去

#### 3.2.3 マッピング生成

- 元カラム名と変換後 snake_case カラム名のマッピング JSON 生成

```python
@app.post("/process")
async def process_file(file_id: str):
    # ファイル読み込み
    # データ構造化
    # マッピング生成
    # 結果返却
```

### 3.3 リアルタイム更新機能

#### 3.3.1 SSE (Server-Sent Events) 実装

- 処理状況のリアルタイム通知
- 営業文面生成進捗の通知

```python
@app.get("/sales-text-stream")
async def sales_text_stream():
    # SSEレスポンスの設定
    # 非同期処理によるデータストリーミング
```

## 4. 非機能要件

### 4.1 パフォーマンス

- 大規模ファイル（10MB 以上）の効率的な処理
- 処理時間の最適化（目標: 5MB 以下のファイルは 30 秒以内）

### 4.2 スケーラビリティ

- 将来的な対応ファイル形式の拡張を考慮した設計
- 処理ロジックの拡張性確保

### 4.3 エラーハンドリング

- 詳細なエラーメッセージの提供
- エラーログの記録
- フロントエンドへの適切なエラー通知

## 5. API 仕様

### 5.1 ファイルアップロード API

**エンドポイント**: `/upload`  
**メソッド**: POST  
**Content-Type**: multipart/form-data  
**パラメータ**:

- file: アップロードするファイル

**レスポンス**:

```json
{
  "success": true,
  "file_id": "uuid-string",
  "file_name": "original-filename.xlsx"
}
```

**エラーレスポンス**:

```json
{
  "success": false,
  "error": "エラーメッセージ",
  "error_code": "ERROR_CODE"
}
```

### 5.2 ファイル処理 API

**エンドポイント**: `/process`  
**メソッド**: POST  
**Content-Type**: application/json  
**リクエストボディ**:

```json
{
  "file_id": "uuid-string"
}
```

**レスポンス**:

```json
{
  "success": true,
  "data": [
    {
      "id": "uuid-string",
      "company_name": "サンプル企業",
      "industry": "IT",
      "contact_person": "担当者名",
      "email": "contact@example.com",
      "phone": "03-1234-5678"
    }
    // ...
  ],
  "mapping": {
    "company_name": "会社名",
    "industry": "業種",
    "contact_person": "担当者",
    "email": "メールアドレス",
    "phone": "電話番号"
  }
}
```

### 5.3 営業文面ストリーム API

**エンドポイント**: `/sales-text-stream`  
**メソッド**: GET  
**Content-Type**: text/event-stream

**ストリームデータ形式**:

```
data: {"id":"uuid-string","text":"営業文面のテキスト"}

```

## 6. LLM 対応のためのデータ形式最適化

### 6.1 LLM 処理に最適なデータ形式

- 一貫した命名規則（snake_case）
- フラットな構造
- 明確なデータ型
- 欠損値の適切な処理

### 6.2 データ前処理の推奨手順

1. カラム名の正規化
2. データ型の統一
3. 欠損値の処理（削除または補完）
4. テキストデータのクリーニング（特殊文字、余分なスペースの除去）

## 7. 実装ガイドライン

### 7.1 コード構造

```
app/
├── main.py              # メインアプリケーション
├── routers/             # APIルーター
│   ├── upload.py        # ファイルアップロード関連
│   ├── process.py       # データ処理関連
│   └── stream.py        # ストリーミング関連
├── services/            # ビジネスロジック
│   ├── file_service.py  # ファイル処理サービス
│   ├── data_service.py  # データ構造化サービス
│   └── llm_service.py   # LLM連携サービス
├── utils/               # ユーティリティ
│   ├── validators.py    # バリデーション関数
│   └── formatters.py    # データフォーマット関数
└── config.py            # 設定ファイル
```

### 7.2 エラーコード定義

- `FILE_NOT_FOUND`: ファイルが見つからない
- `INVALID_FILE_FORMAT`: 非対応のファイル形式
- `MISSING_REQUIRED_COLUMN`: 必須カラムが不足
- `PROCESSING_ERROR`: データ処理中のエラー

## 8. 拡張性と将来計画

### 8.1 対応ファイル形式の拡張

- JSON, XML, PDF などへの対応拡張

### 8.2 高度なデータ処理

- 自然言語処理による高度なカラム推定
- 機械学習モデルによるデータクレンジング

### 8.3 スケーラビリティ

- 非同期処理によるパフォーマンス向上
- マイクロサービスアーキテクチャへの移行検討

## 9. 開発・テストガイドライン

### 9.1 開発環境

- Python 3.9+
- FastAPI 0.68.0+
- pandas 1.3.0+

### 9.2 テスト戦略

- 単体テスト: pytest
- 統合テスト: ファイル処理の一連のフロー
- パフォーマンステスト: 大規模ファイル処理の検証

### 9.3 デプロイメント

- Docker 化
- CI/CD パイプラインの構築

## 10. セキュリティ考慮事項

### 10.1 ファイルアップロードセキュリティ

- ファイルサイズ制限
- ファイル形式の厳格な検証
- ウイルススキャン統合の検討

### 10.2 データセキュリティ

- 個人情報の適切な処理
- 一時ファイルの安全な削除
- アクセス制御の実装

---

本要件定義書は、営業リスト処理システムの開発指針として作成されました。実装の詳細は開発チームの判断に委ねられますが、上記の要件を満たすシステムの構築を目指してください。
